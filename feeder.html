<html>
  <title>Rochester feeder timer</title>
  <head>
    <meta name="viewport" content="width=400">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"/></script>
  </head>
  <body style="font-family: monospace;">
    <div id="offProgress" style="white-space: nowrap; background-color: lightgrey;">buttcatt feeder reset status</div>
    <br>
    last command sent: <span id="display">(ready)</span>
    <br>
    on commands since page load: <span id="ons">0</span>
    <br>
    delay after next resume: <input type="text" id="delay" value="0" size="3">s
    <p>
    <a href="#" onclick="toggle($(this))">resume</a>
    <script>
      var debug = false;
      var ons = 0;
      var onSec  = debug ? 1 : 7;
      var offSec = debug ? 7 : 50;
      var serviceTimeout;
      var offProgressEnd;
      var offProgressTimeout;

      function toggle(e) {
        if ("stop"===e.text()) {
          if ("on"!==$("#display").text()) {
            e.text("resume");
            clearTimeout(serviceTimeout);
          }
        } else {
          e.text("stop");
          turnOnDelay();
        }
      }

      function trigger(action, callback) {
        if (debug) {
          console.log(action);
          callback();
        } else {
          $.ajax({
            crossDomain: true,
            complete: callback,
            url: "https://maker.ifttt.com/trigger/" + action + "/with/key/bHVSnerTzjl27FWY06TXtw"
          });
        }
      }

      function turnOnDelay() {
        serviceTimeout = setTimeout(turnOn, parseInt($('#delay').val()) * 1000);
      }

      function turnOn() {
        $("#display").text("on");
        trigger("feeder_on", turnOnSuccess);
      }

      function turnOnSuccess() {
        ons++;
        $("#ons").text(ons);
        serviceTimeout = setTimeout(turnOff, onSec * 1000);
      }

      function turnOff() {
        $("#display").text("off");
        trigger("feeder_off", turnOffSuccess);
      }

      function turnOffSuccess() {
        serviceTimeout = setTimeout(turnOn, offSec * 1000);
        offProgressDisplay();
      }

      function offProgressDisplay() {
        offProgressPercent(0);
        clearTimeout(offProgressTimeout);
        offProgressEnd = Date.now() + offSec*1000;
        offProgressTimeout = setInterval(offProgressTick, 700);
      }

      function offProgressTick() {
        if (Date.now() > offProgressEnd) {
          clearTimeout(offProgressTimeout);
          offProgressPercent(0);
        } else {
          offProgressPercent(100 - (offProgressEnd - Date.now()) / 10 / offSec);
        }
      }

      function offProgressPercent(p) {
        $("#offProgress").css("width", p + "%");
      }

      offProgressPercent(0);
    </script>
  </body>
</html>
