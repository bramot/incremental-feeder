<html>
  <title>Rochester feeder timer</title>
  <head>
    <meta name="viewport" content="width=400">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"/></script>
  </head>
  <body style="font-family: monospace;">
    buttcatt feeder status:<p>
    last command sent: <span id="display">ready</span>
    <br>
    on commands since page load: <span id="ons">0</span>
    <br>
    <span id="sec"></span>
    <p>
    <a href="#" onclick="toggle($(this))">stop</a>
    <script>
      var ons = 0;
      var onSec = 7;
      var offSec = 50;
      var serviceTimeout;

      function toggle(e) {
        if ("stop"===e.text()) {
          if ("on"!==$("#display").text()) {
            e.text("resume");
            clearTimeout(serviceTimeout);
          }
        } else {
          e.text("stop");
          turnOn();
        }
      }

      function trigger(action, callback) {
        $.ajax({
          crossDomain: true,
          complete: callback,
          url: "https://maker.ifttt.com/trigger/" + action + "/with/key/bHVSnerTzjl27FWY06TXtw"
        });
      }

      function turnOn() {
        trigger("feeder_on", turnOnSuccess);
      }

      function turnOnSuccess() {
        $("#display").text("on");
        ons++;
        $("#ons").text(ons);
        serviceTimeout = setTimeout(turnOff, onSec * 1000);
      }

      function turnOff() {
        trigger("feeder_off", turnOffSuccess);
      }

      function turnOffSuccess() {
        $("#display").text("off");
        serviceTimeout = setTimeout(turnOn, offSec * 1000);
      }

      turnOn();
    </script>
  </body>
</html>
