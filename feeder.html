<html>
  <title>Rochester feeder timer</title>
  <head>
    <meta name="viewport" content="width=400">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"/></script>
  </head>
  <body style="font-family: monospace;">
    buttcatt feeder status:<p>
    last command sent: <span id="display">ready</span>
    <br>
    on commands since page load: <span id="ons">0</span>
    <br>
    delay before start: <input type="text" id="delay" value="1" size="3">s
    <p>
    <a href="#" onclick="toggle($(this))">stop</a>
    <script>
      var debug = false;
      var ons = 0;
      var onSec  = debug ? 1 : 7;
      var offSec = debug ? 3 : 50;
      var serviceTimeout;

      function toggle(e) {
        if ("stop"===e.text()) {
          if ("on"!==$("#display").text()) {
            e.text("resume");
            clearTimeout(serviceTimeout);
          }
        } else {
          e.text("stop");
          turnOnDelay();
        }
      }

      function trigger(action, callback) {
        if (debug) {
          console.log(action);
          callback();
        } else {
          $.ajax({
            crossDomain: true,
            complete: callback,
            url: "https://maker.ifttt.com/trigger/" + action + "/with/key/bHVSnerTzjl27FWY06TXtw"
          });
        }
      }

      function turnOnDelay() {
        serviceTimeout = setTimeout(turnOn, parseInt($('#delay').val()) * 1000);
      }

      function turnOn() {
        $("#display").text("on");
        trigger("feeder_on", turnOnSuccess);
      }

      function turnOnSuccess() {
        ons++;
        $("#ons").text(ons);
        serviceTimeout = setTimeout(turnOff, onSec * 1000);
      }

      function turnOff() {
        $("#display").text("off");
        trigger("feeder_off", turnOffSuccess);
      }

      function turnOffSuccess() {
        serviceTimeout = setTimeout(turnOn, offSec * 1000);
      }

      turnOnDelay();
    </script>
  </body>
</html>
